<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ü§ñ Smart Energy AI Chatbot</title>
<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background-color: #f4f6f9;
    color: #333;
    margin: 0;
    padding: 0;
  }
  header {
    background-color: #004aad;
    color: white;
    text-align: center;
    padding: 15px;
    font-size: 1.4rem;
    font-weight: 600;
  }
  main {
    max-width: 900px;
    margin: 30px auto;
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  h2 {
    color: #004aad;
    text-align: center;
  }
  input {
    width: 100%;
    padding: 12px;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  button {
    background: #004aad;
    color: white;
    border: none;
    padding: 10px 18px;
    margin-top: 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
  }
  button:hover {
    background: #003b87;
  }
  .status-box {
    background: #eef3fc;
    border: 1px solid #cdd8f0;
    border-radius: 6px;
    padding: 10px;
    margin-top: 15px;
    font-weight: 500;
  }
  .status-ok { color: green; }
  .status-progress { color: #e68a00; }
  .status-error { color: red; }
  .split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 25px;
  }
  @media (max-width: 700px) {
    .split { grid-template-columns: 1fr; }
  }
  .section {
    background: #f9fafc;
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
  }
  #formattedSummary {
    font-size: 0.95rem;
    line-height: 1.5;
  }
  #formattedSummary h3 {
    color: #004aad;
    margin-top: 10px;
  }
  #formattedSummary ul {
    list-style-type: disc;
    margin-left: 20px;
  }
  #formattedSummary p {
    margin: 8px 0;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    background: #f0f3f8;
    padding: 10px;
    border-radius: 6px;
  }
  .footer {
    text-align: center;
    margin-top: 25px;
    font-size: 0.9rem;
    color: #555;
  }
</style>
</head>
<body>

<header>ü§ñ Smart Energy AI Chatbot</header>

<main>
  <h2>Ask about your IoT and Energy Data</h2>
  <p>Type a natural language question about your devices or energy usage to get instant insights.</p>

  <input id="userInput" type="text" placeholder="Example: How many devices do we have in the database?"
    onfocus="this.placeholder=''" 
    onblur="this.placeholder='Example: How many devices do we have in the database?'" />

  <div class="status-box" id="statusBox">
    üîó <b>Status:</b> <span id="statusText" class="status-ok">Connected and ready</span> 
    <span id="timer" style="float:right; font-weight:600;"></span>
  </div>

  <button onclick="sendQuery()">Send Query</button>
  <button onclick="clearChat()">Clear Chat</button>

  <div class="split">
    <div class="section">
      <h3>üßæ Raw API Response</h3>
      <div id="rawResponse">Waiting for request...</div>
    </div>

    <div class="section">
      <h3>üß† Formatted Summary</h3>
      <div id="formattedSummary">Summary will appear here.</div>
    </div>
  </div>

  <div class="footer">
    üîó Endpoint: <code>https://5q6pe4lffj.execute-api.us-east-1.amazonaws.com/DEV/TalkSmartEnergy</code>
  </div>
</main>

<script>
let timerInterval;
let startTime;

function startTimer() {
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    document.getElementById("timer").textContent = `‚è± ${elapsed}s`;
  }, 100);
}

function stopTimer() {
  clearInterval(timerInterval);
}

async function sendQuery() {
  const input = document.getElementById("userInput").value.trim();
  const rawBox = document.getElementById("rawResponse");
  const summaryBox = document.getElementById("formattedSummary");
  const statusText = document.getElementById("statusText");
  const timer = document.getElementById("timer");

  if (!input) {
    rawBox.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Please type a question before sending.</p>";
    return;
  }

  rawBox.innerHTML = "‚è≥ Sending request to API...";
  summaryBox.innerHTML = "Processing...";
  statusText.textContent = "Processing request...";
  statusText.className = "status-progress";
  timer.textContent = "";
  startTimer();

  try {
    const response = await fetch("https://5q6pe4lffj.execute-api.us-east-1.amazonaws.com/DEV/TalkSmartEnergy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: input })
    });

    const text = await response.text();

    // --- Clean and format the raw JSON visually ---
    const cleanText = text
      .replace(/\\n/g, "\n")
      .replace(/\\"/g, '"')
      .replace(/\\\\/g, '\\')
      .replace(/\},/g, "},\n")
      .replace(/\{/g, "\n{")
      .replace(/},/g, "},\n");
    rawBox.innerHTML = `<pre>${cleanText}</pre>`;

    // --- Try parsing JSON safely ---
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      stopTimer();
      summaryBox.innerHTML = "<p style='color:red;'>‚ùå Unable to parse JSON response.</p>";
      statusText.textContent = "Response error";
      statusText.className = "status-error";
      return;
    }

    stopTimer();

    // --- Try to parse body if it is JSON-encoded ---
    let parsedBody;
    try {
      parsedBody = JSON.parse(data.body);
    } catch {
      parsedBody = {};
    }

    const summaryText =
      parsedBody.summary || data.summary || "<p>No summary found in response.</p>";

    if (data.error) {
      summaryBox.innerHTML = `<p style='color:red;'>‚ùå ${data.error}</p>`;
      statusText.textContent = "Error from API";
      statusText.className = "status-error";
    } else {
      summaryBox.innerHTML = cleanSummary(summaryText);
      statusText.textContent = "‚úÖ Completed successfully";
      statusText.className = "status-ok";
    }

  } catch (error) {
    stopTimer();
    rawBox.innerHTML = `<p style='color:red;'>‚ùå Connection or CORS error<br><small>${error.message}</small></p>`;
    summaryBox.innerHTML = "";
    statusText.textContent = "Connection error";
    statusText.className = "status-error";
  }
}

function cleanSummary(summary) {
  let formatted = summary
    .replace(/\\n/g, "<br>")
    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
    .replace(/### (.*?)(<br>|$)/g, "<h3>$1</h3>")
    .replace(/- (.*?)(<br>|$)/g, "<li>$1</li>");
  
  if (formatted.includes("<li>")) {
    formatted = formatted.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");
  }
  return formatted;
}

function clearChat() {
  document.getElementById("userInput").value = "";
  document.getElementById("rawResponse").innerHTML = "Waiting for request...";
  document.getElementById("formattedSummary").innerHTML = "Summary will appear here.";
  document.getElementById("statusText").textContent = "Connected and ready";
  document.getElementById("statusText").className = "status-ok";
  document.getElementById("timer").textContent = "";
  clearInterval(timerInterval);
}
</script>

</body>
</html>

